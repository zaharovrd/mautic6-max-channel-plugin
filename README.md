# Mautic 6 MAX Channel Plugin

Интеграция с **MAX Bot API** в качестве канала коммуникаций для Mautic 6. Этот плагин позволяет:
- Отправлять сообщения контактам через MAX из конструктора кампаний Mautic.
- Использовать токены Mautic (например, `{contact.firstname}`) в тексте сообщений.
- Получать ответы от пользователей и видеть их в таймлайне контакта.
- Реагировать на нажатия кнопок в MAX.

---

## Установка и настройка

### 1. Установка плагина

- Скопируйте содержимое этого репозитория в папку `/plugins/MauticMaxBundle` вашего Mautic.
- Очистите кеш Mautic:
  ```bash
  php /path/to/mautic/bin/console cache:clear
  ```

### 2. Настройка интеграции

- Перейдите в **Настройки Mautic** (значок шестеренки) > **Плагины** и нажмите "Установить/обновить плагины".
- Перейдите в **Настройки Mautic** > **Интеграции**.
- Найдите интеграцию **MAX** и нажмите на нее.
- Переключите "Опубликован" в положение "Да".
- В поле **Access Token** вставьте токен доступа вашего бота, полученный от MAX.
- Нажмите **"Применить"** и затем **"Сохранить и закрыть"**.

### 3. Создание кастомного поля

Чтобы Mautic знал, какому пользователю в MAX отправлять сообщение, необходимо связать контакты.

- Перейдите в **Настройки Mautic** > **Кастомные поля**.
- Создайте новое поле для объекта "Контакты".
- **Название:** `MAX User ID`
- **Алиас:** `max_user_id` (важно, чтобы алиас был именно таким!)
- **Тип данных:** Текст
- Сохраните поле. Теперь в это поле для каждого контакта нужно будет записывать его числовой ID из мессенджера MAX.

### 4. Настройка Webhook в MAX

Чтобы Mautic получал входящие сообщения и статусы, нужно настроить Webhook.
- В настройках интеграции MAX в Mautic вы найдете сгенерированный **URL для Webhook**. Скопируйте его.
- Укажите этот URL в настройках вашего бота на стороне MAX API.
- Выберите события для отправки: `message_created`, `message_callback`, `bot_started` и другие, которые вам необходимы.

---

## Использование

### Создание сообщения

1.  Перейдите в **Каналы** > **Marketing Messages**.
2.  Нажмите **"Создать"**.
3.  Выберите **"MAX Message"** в качестве типа.
4.  Напишите текст сообщения. Вы можете использовать любые токены Mautic, например `Привет, {contact.firstname}!`.
5.  Сохраните сообщение.

### Использование в кампании

1.  Откройте нужную кампанию в конструкторе.
2.  Выберите "Действие".
3.  В списке действий найдите **"Send MAX message"**.
4.  В настройках действия выберите из выпадающего списка ранее созданное сообщение.
5.  Сохраните и запустите кампанию.

Когда кампания дойдет до этого шага, Mautic отправит выбранное сообщение контакту в MAX.